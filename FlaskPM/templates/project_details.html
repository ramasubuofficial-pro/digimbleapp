{% extends "base.html" %}

{% block header_title %}Project Details{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center space-x-2 text-sm text-slate-500 mb-2">
        <a href="{{ url_for('views.projects') }}" class="hover:text-emerald-600">Projects</a>
        <span>/</span>
        <span class="text-slate-800 font-medium">Project #{{ project_id[:8] }}...</span>
    </div>

    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2" id="project-title-header">Loading...</h1>
            <p class="text-slate-500 max-w-2xl" id="project-desc-header"></p>

            <!-- Project Meta Info -->
            <div class="flex items-start gap-8 mt-6">
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-1">Timeline</h4>
                    <div class="flex items-center text-sm font-medium text-slate-700">
                        <svg class="w-4 h-4 mr-2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span id="project-timeline">Loading...</span>
                    </div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-1">Team</h4>
                    <div class="flex -space-x-2" id="project-team-list">
                        <span class="text-xs text-slate-400">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <button id="add-member-btn" onclick="openAddMemberModal()"
                class="hidden px-4 py-2 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                </svg>
                Add Member
            </button>
            <button onclick="openCreateTaskModal()"
                class="px-4 py-2 bg-emerald-600 text-white rounded-xl shadow-lg shadow-emerald-500/30 hover:bg-emerald-700 transition flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Task
            </button>
        </div>
    </div>
</div>

<!-- Task Board (Kanban-ish) -->
<div class="flex overflow-x-auto pb-4 space-x-6 h-[calc(100vh-250px)]">

    <!-- Column: To Do -->
    <div class="w-80 flex-shrink-0 flex flex-col bg-slate-100/50 rounded-2xl border border-slate-200">
        <div class="p-4 flex items-center justify-between border-b border-white/50">
            <h3 class="font-bold text-slate-700">To Do</h3>
            <span class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold"
                id="count-todo">0</span>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-3" id="col-todo">
            <!-- Tasks go here -->
        </div>
    </div>

    <!-- Column: In Progress -->
    <div class="w-80 flex-shrink-0 flex flex-col bg-slate-100/50 rounded-2xl border border-slate-200">
        <div class="p-4 flex items-center justify-between border-b border-white/50">
            <h3 class="font-bold text-amber-700">In Progress</h3>
            <span class="bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full text-xs font-bold"
                id="count-inprogress">0</span>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-3" id="col-inprogress">
        </div>
    </div>

    <!-- Column: Completed -->
    <div class="w-80 flex-shrink-0 flex flex-col bg-slate-100/50 rounded-2xl border border-slate-200">
        <div class="p-4 flex items-center justify-between border-b border-white/50">
            <h3 class="font-bold text-emerald-700">Completed</h3>
            <span class="bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold"
                id="count-completed">0</span>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-3" id="col-completed">
        </div>
    </div>

</div>

<!-- Create Task Modal -->
<div id="create-task-modal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl p-6" id="create-task-content">
        <h3 class="text-xl font-bold mb-4">New Task</h3>
        <div class="space-y-4">
            <input type="text" id="task-title" placeholder="Task Title"
                class="w-full px-4 py-2 border rounded-lg bg-slate-50 focus:bg-white transition"
                oninput="document.getElementById('task-error-msg').classList.add('hidden')">
            <!-- Inline Error Message -->
            <div id="task-error-msg" class="hidden text-red-500 text-sm px-2 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="task-error-text">Title is required</span>
            </div>
            <textarea id="task-desc" placeholder="Description" rows="3"
                class="w-full px-4 py-2 border rounded-lg bg-slate-50 focus:bg-white transition"
                oninput="document.getElementById('desc-error-msg').classList.add('hidden')"></textarea>
            <div id="desc-error-msg" class="hidden text-red-500 text-sm px-2 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="desc-error-text">Description is required</span>
            </div>
            <div class="flex space-x-4">
                <div class="w-1/3">
                    <select id="task-priority" class="w-full px-4 py-2 border rounded-lg bg-slate-50">
                        <option value="Low">Low Priority</option>
                        <option value="Medium" selected>Medium Priority</option>
                        <option value="High">High Priority</option>
                    </select>
                </div>
                <div class="w-1/3">
                    <select id="task-assignee" class="w-full px-4 py-2 border rounded-lg bg-slate-50"
                        oninput="document.getElementById('assignee-error-msg').classList.add('hidden')">
                        <option value="">Unassigned</option>
                        <!-- Populated via JS -->
                    </select>
                    <div id="assignee-error-msg" class="hidden text-red-500 text-xs mt-1">
                        Assignee is required
                    </div>
                </div>
                <div class="w-1/3 relative">
                    <input type="text" id="task-deadline" placeholder="Deadline"
                        class="w-full pl-10 pr-4 py-2 border rounded-lg bg-slate-50 focus:bg-white cursor-pointer"
                        oninput="document.getElementById('deadline-error-msg').classList.add('hidden')">
                    <svg class="absolute left-3 top-2.5 w-5 h-5 text-slate-400 pointer-events-none" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <div id="deadline-error-msg" class="hidden text-red-500 text-xs mt-1">
                        Deadline is required
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="document.getElementById('create-task-modal').classList.add('hidden')"
                class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
            <button onclick="createTask()"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-lg shadow-emerald-500/30">Create
                Task</button>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="edit-task-modal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl p-6">
        <h3 class="text-xl font-bold mb-4">Edit Task</h3>
        <input type="hidden" id="edit-task-id">
        <div class="space-y-4">
            <input type="text" id="edit-task-title" placeholder="Task Title"
                class="w-full px-4 py-2 border rounded-lg bg-slate-50 focus:bg-white transition">

            <textarea id="edit-task-desc" placeholder="Description" rows="3"
                class="w-full px-4 py-2 border rounded-lg bg-slate-50 focus:bg-white transition"></textarea>

            <div class="flex space-x-4">
                <div class="w-1/3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Priority</label>
                    <select id="edit-task-priority" class="w-full px-4 py-2 border rounded-lg bg-slate-50">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="w-1/3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
                    <select id="edit-task-status" class="w-full px-4 py-2 border rounded-lg bg-slate-50">
                        <option value="To Do">To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="w-1/3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assignee</label>
                    <select id="edit-task-assignee" class="w-full px-4 py-2 border rounded-lg bg-slate-50">
                        <option value="">Unassigned</option>
                    </select>
                </div>
            </div>
            <div class="relative">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Deadline</label>
                <input type="text" id="edit-task-deadline" placeholder="Select Date..."
                    class="w-full pl-10 pr-4 py-2 border rounded-lg bg-slate-50 focus:bg-white cursor-pointer">
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="document.getElementById('edit-task-modal').classList.add('hidden')"
                class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
            <button onclick="updateTask()"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-500/30">Save
                Changes</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>
        <h3 id="del-modal-title" class="text-lg font-bold text-slate-900 mb-2">Delete Item?</h3>
        <p id="del-modal-desc" class="text-sm text-slate-500 mb-6">Are you sure you want to delete this?</p>
        <div class="flex space-x-3 justify-center">
            <button onclick="document.getElementById('delete-confirm-modal').classList.add('hidden')"
                class="px-4 py-2 bg-slate-100 text-slate-700 hover:bg-slate-200 rounded-lg font-medium transition">Cancel</button>
            <button id="del-modal-btn"
                class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg font-medium shadow-lg shadow-red-500/30 transition">Yes,
                Delete</button>
        </div>
    </div>
</div>

<!-- Task Preview Modal (Enhanced) -->
<div id="task-preview-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col h-[85vh]">
        <!-- Header -->
        <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50/80">
            <div class="flex-1 mr-4">
                <div class="flex items-center space-x-3 mb-2">
                    <span id="preview-priority"
                        class="text-xs font-bold px-2 py-0.5 rounded uppercase tracking-wider"></span>
                    <span id="preview-status"
                        class="text-xs font-semibold px-2 py-0.5 rounded border border-slate-200 text-slate-500"></span>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 break-words" id="preview-title">Loading...</h3>
            </div>
            <button onclick="document.getElementById('task-preview-modal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600 transition p-1 hover:bg-slate-200 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-slate-200 bg-white">
            <button onclick="switchTab('details')" id="tab-btn-details"
                class="flex-1 py-3 text-sm font-medium text-emerald-600 border-b-2 border-emerald-600 transition">Details</button>
            <button onclick="switchTab('comments')" id="tab-btn-comments"
                class="flex-1 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">Comments</button>
            <button onclick="switchTab('attachments')" id="tab-btn-attachments"
                class="flex-1 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">Attachments</button>
        </div>

        <!-- Body Content -->
        <div class="flex-1 overflow-y-auto bg-slate-50 p-6" id="modal-body-scroll">

            <!-- Tab: Details -->
            <div id="tab-content-details" class="space-y-6">
                <!-- Description -->
                <div>
                    <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-2">Description</h4>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p id="preview-desc" class="text-slate-700 leading-relaxed whitespace-pre-wrap font-sans"></p>
                    </div>
                </div>

                <!-- Meta Grid -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Assigned To</h4>
                        <div class="flex items-center space-x-3" id="preview-assignee-box"></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Due Date</h4>
                        <div class="flex items-center space-x-2 text-slate-700 font-medium">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            <span id="preview-deadline"></span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-1">Created By</h4>
                        <span id="preview-creator" class="text-slate-600">System</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-1">Created On</h4>
                        <span id="preview-created" class="text-slate-600"></span>
                    </div>
                </div>
            </div>

            <!-- Tab: Comments -->
            <div id="tab-content-comments" class="hidden h-full flex flex-col">
                <div class="flex-1 overflow-y-auto space-y-4 mb-4 pr-2" id="comments-list">
                    <!-- Comments injected here -->
                    <div class="text-center text-slate-400 py-10">Loading comments...</div>
                </div>
                <!-- Comment Input -->
                <div
                    class="mt-auto bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex items-start space-x-2">
                    <textarea id="new-comment-text" rows="2" placeholder="Write a comment..."
                        class="flex-1 bg-transparent border-none focus:ring-0 resize-none text-sm"></textarea>
                    <button onclick="postComment()"
                        class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Tab: Attachments -->
            <div id="tab-content-attachments" class="hidden space-y-4">

                <!-- Upload Area -->
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:bg-slate-50 transition cursor-pointer"
                    onclick="document.getElementById('file-upload-input').click()">
                    <input type="file" id="file-upload-input" class="hidden" onchange="uploadAttachment(this.files[0])">
                    <svg class="w-10 h-10 text-slate-400 mx-auto mb-2" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <p class="text-sm text-slate-500 font-medium">Click to upload file</p>
                    <p class="text-xs text-slate-400 mt-1">Supports images, docs, pdf (Max 5MB)</p>
                </div>
                <div id="upload-progress" class="hidden w-full bg-slate-200 rounded-full h-1.5 mt-2">
                    <div class="bg-emerald-600 h-1.5 rounded-full" style="width: 50%"></div>
                </div>

                <!-- File List -->
                <h4 class="text-xs font-bold text-slate-400 uppercase mt-6 mb-2">Attached Files</h4>
                <div id="attachments-list" class="space-y-3">
                    <div class="text-center text-slate-400 py-4">No attachments yet.</div>
                </div>
            </div>

        </div>

        <!-- Footer Actions -->
        <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
            <button
                onclick="deleteTask(currentPreviewTaskId); document.getElementById('task-preview-modal').classList.add('hidden')"
                class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center px-2 py-1 hover:bg-red-50 rounded transition">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862A2 2 0 016.862 21L6 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
                Delete Task
            </button>
            <div class="flex space-x-3">
                <button onclick="document.getElementById('task-preview-modal').classList.add('hidden')"
                    class="px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-lg text-sm font-medium shadow-sm transition">Close</button>
                <button
                    onclick="openEditTaskModal(currentPreviewTaskId); document.getElementById('task-preview-modal').classList.add('hidden')"
                    class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-medium shadow-sm transition flex items-center">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                        </path>
                    </svg>
                    Edit Task
                </button>
            </div>
        </div>
    </div>
</div>

</div>

<!-- Add Member Modal -->
<div id="add-member-modal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-4">Add Team Member</h3>
        <p class="text-sm text-slate-500 mb-4">Select a user to add to this project.</p>

        <div class="space-y-4">
            <div>
                <select id="new-member-select"
                    class="w-full px-4 py-2 border border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition">
                    <option value="">Loading users...</option>
                </select>
            </div>
        </div>

        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="document.getElementById('add-member-modal').classList.add('hidden')"
                class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition">Cancel</button>
            <button onclick="addMember()"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition">Add
                Member</button>
        </div>
    </div>
</div>

<script>
    const PROJECT_ID = '{{ project_id }}';
    const CURRENT_USER_ROLE = "{{ role }}";
    let projectMemberIDs = [];
    let teamMembers = [];
    let currentProjectTasks = [];
    let currentPreviewTaskId = null;
    let deleteTargetId = null;

    async function openCreateTaskModal() {
        // Reset Fields
        document.getElementById('task-title').value = '';
        document.getElementById('task-desc').value = '';
        document.getElementById('task-priority').value = 'Medium';
        document.getElementById('task-assignee').value = '';
        document.getElementById('task-deadline').value = '';

        // Hide Errors
        ['task-error-msg', 'desc-error-msg', 'assignee-error-msg', 'deadline-error-msg'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });

        document.getElementById('create-task-modal').classList.remove('hidden');
        populateAssigneeSelect('task-assignee');
    }

    function populateAssigneeSelect(selectId, selectedId = null) {
        const sel = document.getElementById(selectId);
        if (!sel) return;
        // Reset
        sel.innerHTML = '<option value="">' + (selectId === 'task-assignee' ? 'Assign To...' : 'Unassigned') + '</option>';

        if (teamMembers.length === 0) {
            // Optional: Show "No members" if really empty
            return;
        }

        teamMembers.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.innerText = u.full_name || u.email || 'Unknown';
            if (selectedId && u.id === selectedId) opt.selected = true;
            sel.appendChild(opt);
        });
    }



    document.addEventListener('DOMContentLoaded', () => {
        loadProjectDetails();
        loadTasks();

        // Initialize Flatpickr
        flatpickr("#task-deadline", { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today", theme: "dark" });
        flatpickr("#edit-task-deadline", { enableTime: true, dateFormat: "Y-m-d H:i", theme: "dark" });
    });

    async function loadProjectDetails() {
        try {
            const res = await fetch(`/api/projects/${PROJECT_ID}`);
            if (res.ok) {
                const project = await res.json();
                document.getElementById('project-title-header').innerText = project.title;
                document.getElementById('project-desc-header').innerText = project.description || 'No description provided.';

                // Display Dates
                const start = project.start_date ? new Date(project.start_date).toLocaleDateString() : 'TBD';
                const end = project.end_date ? new Date(project.end_date).toLocaleDateString() : 'TBD';
                document.getElementById('project-timeline').innerText = `${start} - ${end}`;

                // Display Team
                const teamBox = document.getElementById('project-team-list');
                teamBox.innerHTML = '';
                if (project.members && project.members.length > 0) {
                    projectMemberIDs = project.members.map(m => m.id);
                    teamMembers = project.members; // Store for Dropdowns
                    project.members.forEach(m => {
                        const avatar = m.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(m.full_name)}`;
                        const img = document.createElement('img');
                        img.src = avatar;
                        img.className = 'w-8 h-8 rounded-full border-2 border-white ring-1 ring-slate-100';
                        img.title = `${m.full_name} (${m.role})`;
                        teamBox.appendChild(img);
                    });
                } else {
                    projectMemberIDs = [];
                    teamBox.innerHTML = '<span class="text-xs text-slate-400 italic mt-1">No members</span>';
                }

                // Show Add Button if Admin
                if (CURRENT_USER_ROLE === 'Admin') {
                    document.getElementById('add-member-btn').classList.remove('hidden');
                }

            } else {
                document.getElementById('project-title-header').innerText = 'Project Not Found';
            }
        } catch (e) {
            console.error("Error loading project details:", e);
        }
    }

    async function loadTasks() {
        const res = await fetch(`/api/projects/${PROJECT_ID}/tasks`);
        const tasks = await res.json();
        currentProjectTasks = tasks; // Store for lookup

        // Clear columns
        ['todo', 'inprogress', 'completed'].forEach(k => {
            document.getElementById(`col-${k}`).innerHTML = '';
            document.getElementById(`count-${k}`).innerText = '0';
        });

        const counts = { todo: 0, inprogress: 0, completed: 0 };

        tasks.forEach(t => {
            const statusKey = t.status.toLowerCase().replace(' ', ''); // 'to do' -> 'todo', 'in progress' -> 'inprogress'
            const col = document.getElementById(`col-${statusKey}`);
            if (col) {
                counts[statusKey]++;
                const card = createTaskCard(t);
                col.appendChild(card);
            }
        });

        // Update counts
        Object.keys(counts).forEach(k => {
            document.getElementById(`count-${k}`).innerText = counts[k];
        });
    }

    function createTaskCard(t) {
        const el = document.createElement('div');
        el.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition group relative cursor-pointer';
        el.draggable = true;
        // On click, open preview
        el.onclick = (e) => {
            // Prevent if clicking the move button
            if (e.target.closest('button')) return;
            openTaskPreview(t.id);
        };

        // Priority Color
        let pColor = 'bg-slate-100 text-slate-600';
        if (t.priority === 'High') pColor = 'bg-red-100 text-red-600';
        if (t.priority === 'Medium') pColor = 'bg-orange-100 text-orange-600';
        if (t.priority === 'Low') pColor = 'bg-green-100 text-green-600';

        // Assigned user
        const assignee = t.assignee;
        const avatar = assignee ? (assignee.avatar_url || 'https://ui-avatars.com/api/?name=' + assignee.full_name) : null;
        const name = assignee ? assignee.full_name : 'Unassigned';

        el.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="text-xs font-bold px-2 py-0.5 rounded ${pColor}">${t.priority}</span>
                <button class="text-slate-300 hover:text-blue-500 hidden group-hover:block" onclick="moveTask('${t.id}', '${t.status}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <h4 class="font-semibold text-slate-800 text-sm mb-1">${t.title}</h4>
            <div class="flex items-center justify-between mt-3">
                <div class="flex -space-x-2">
                    ${assignee ? `<img src="${avatar}" class="w-6 h-6 rounded-full border-2 border-white" title="Assigned to ${name}">` : '<span class="text-xs text-slate-300 italic">Unassigned</span>'}
                </div>
                <span class="text-xs text-slate-400 font-medium" title="Created: ${new Date(t.created_at).toLocaleString()}">
                    ${new Date(t.created_at).toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                </span>
            </div>
        `;
        return el;
    }

    function openTaskPreview(taskId) {
        currentPreviewTaskId = taskId;
        const t = currentProjectTasks.find(x => x.id === taskId);
        if (!t) return;

        document.getElementById('preview-title').innerText = t.title;
        document.getElementById('preview-desc').innerText = t.description || 'No description provided.';
        document.getElementById('preview-status').innerText = t.status;
        document.getElementById('preview-created').innerText = new Date(t.created_at).toLocaleDateString();

        // Priority
        const pEl = document.getElementById('preview-priority');
        pEl.innerText = t.priority;
        pEl.className = 'text-xs font-bold px-2 py-0.5 rounded uppercase tracking-wider ';
        if (t.priority === 'High') pEl.classList.add('bg-red-100', 'text-red-700');
        else if (t.priority === 'Medium') pEl.classList.add('bg-orange-100', 'text-orange-700');
        else pEl.classList.add('bg-green-100', 'text-green-700');

        // Deadline
        const dEl = document.getElementById('preview-deadline');
        if (t.deadline) {
            dEl.innerText = new Date(t.deadline).toLocaleString(undefined, {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
            dEl.classList.remove('text-slate-400', 'italic');
        } else {
            dEl.innerText = 'No Deadline';
            dEl.classList.add('text-slate-400', 'italic');
        }

        // Assignee
        const aBox = document.getElementById('preview-assignee-box');
        if (t.assignee) {
            const avatar = t.assignee.avatar_url || ('https://ui-avatars.com/api/?name=' + t.assignee.full_name);
            aBox.innerHTML = `
                <img src="${avatar}" class="w-8 h-8 rounded-full border border-slate-200">
                <span class="text-sm font-semibold text-slate-700">${t.assignee.full_name}</span>
             `;
        } else {
            aBox.innerHTML = '<span class="text-sm text-slate-400 italic">Unassigned</span>';
        }

        // Creator (Note: backend doesn't currently join created_by info in detail, might effectively be sparse or we assume current user methods?)
        // Task schema has created_by UUID, but fetching /tasks endpoint only joins assignee.
        // We might not have Creator Name unless we update the backend to join it.
        // For now, let's just show "Unknown" or skip if data missing.
        document.getElementById('preview-creator').innerText = 'System / Admin';

        document.getElementById('task-preview-modal').classList.remove('hidden');
    }

    async function createTask() {
        const title = document.getElementById('task-title').value;
        const desc = document.getElementById('task-desc').value;
        const priority = document.getElementById('task-priority').value;
        const deadlineVal = document.getElementById('task-deadline').value;
        const assigned_to = document.getElementById('task-assignee').value;

        let isValid = true;
        if (!title.trim()) {
            showInputError('task-error-msg', 'task-error-text', 'Title is required');
            isValid = false;
        }
        if (!desc.trim()) {
            showInputError('desc-error-msg', 'desc-error-text', 'Description is required');
            isValid = false;
        }
        if (!assigned_to) {
            document.getElementById('assignee-error-msg').classList.remove('hidden');
            isValid = false;
        }
        if (!deadlineVal) {
            document.getElementById('deadline-error-msg').classList.remove('hidden');
            isValid = false;
        }

        if (!isValid) return;

        // Convert Deadline to ISO String respecting Local Time
        // Flatpickr gives "YYYY-MM-DD HH:mm" (local)
        // new Date("YYYY-MM-DD HH:mm") creates a local date object.
        // .toISOString() converts that local instant to UTC ISO string.
        // This ensures Supabase receives the correct UTC equivalent of the user's local time.
        const deadlineISO = new Date(deadlineVal).toISOString();

        const res = await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_id: PROJECT_ID,
                title, description: desc, priority,
                deadline: deadlineISO,
                assigned_to
            })
        });

        if (res.ok) {
            document.getElementById('create-task-modal').classList.add('hidden');
            loadTasks();
            // Reset
            document.getElementById('task-title').value = '';
            document.getElementById('task-desc').value = '';
        } else {
            const err = await res.json();
            showInputError('task-error-msg', 'task-error-text', err.error || 'Unknown error');
        }
    }


    // --- NEW: Edit & Delete Logic ---

    async function openEditTaskModal(taskId) {
        const task = currentProjectTasks.find(t => t.id === taskId);
        if (!task) return;

        document.getElementById('edit-task-id').value = task.id;
        document.getElementById('edit-task-title').value = task.title;
        document.getElementById('edit-task-desc').value = task.description || '';
        document.getElementById('edit-task-priority').value = task.priority;
        document.getElementById('edit-task-status').value = task.status;

        // Populate Assignee for Edit
        populateAssigneeSelect('edit-task-assignee', task.assigned_to);

        // Deadline
        const fp = document.getElementById('edit-task-deadline')._flatpickr;
        if (fp) fp.setDate(task.deadline || null);

        document.getElementById('edit-task-modal').classList.remove('hidden');
    }

    async function updateTask() {
        const id = document.getElementById('edit-task-id').value;
        const title = document.getElementById('edit-task-title').value.trim();
        const desc = document.getElementById('edit-task-desc').value.trim();
        const priority = document.getElementById('edit-task-priority').value;
        const status = document.getElementById('edit-task-status').value;
        const assigned_to = document.getElementById('edit-task-assignee').value;
        const deadlineVal = document.getElementById('edit-task-deadline').value;

        if (!title) { alert("Title is required"); return; }

        let deadlineISO = null;
        if (deadlineVal) deadlineISO = new Date(deadlineVal).toISOString();

        try {
            const res = await fetch(`/api/tasks/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description: desc, priority, status, assigned_to, deadline: deadlineISO })
            });

            if (res.ok) {
                document.getElementById('edit-task-modal').classList.add('hidden');
                showToast('Action successful', 'success');
                loadTasks();
            } else {
                alert("Failed to update");
            }
        } catch (e) { console.error(e); }
    }

    function deleteTask(taskId) {
        deleteTargetId = taskId;
        document.getElementById('del-modal-title').innerText = 'Delete Task?';
        document.getElementById('del-modal-desc').innerText = 'Are you sure you want to permanently delete this task?';

        const btn = document.getElementById('del-modal-btn');
        btn.onclick = confirmDeleteTask;

        document.getElementById('delete-confirm-modal').classList.remove('hidden');
    }

    async function confirmDeleteTask() {
        if (!deleteTargetId) return;
        try {
            const res = await fetch(`/api/tasks/${deleteTargetId}`, { method: 'DELETE' });
            if (res.ok) {
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                loadTasks();
            } else {
                alert("Failed to delete");
            }
        } catch (e) { console.error(e); }
    }

    function showInputError(containerId, textId, msg) {
        document.getElementById(textId).innerText = msg;
        document.getElementById(containerId).classList.remove('hidden');
    }

    async function moveTask(taskId, currentStatus) {
        // Simple cycler: To Do -> In Progress -> Completed -> To Do
        let next = 'To Do';
        if (currentStatus === 'To Do') next = 'In Progress';
        else if (currentStatus === 'In Progress') next = 'Completed';

        await fetch(`/api/tasks/${taskId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: next })
        });
        loadTasks();
    }

    // --- Add Member Logic ---
    async function openAddMemberModal() {
        document.getElementById('add-member-modal').classList.remove('hidden');
        const sel = document.getElementById('new-member-select');
        sel.innerHTML = '<option>Loading...</option>';
        sel.disabled = true;

        try {
            const res = await fetch('/api/team');
            if (res.ok) {
                const allUsers = await res.json();
                // Filter out existing members
                const startLen = allUsers.length;
                const available = allUsers.filter(u => !projectMemberIDs.includes(u.id));

                sel.innerHTML = '<option value="">Select User...</option>';
                available.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.innerText = `${u.full_name || u.email} (${u.role})`;
                    sel.appendChild(opt);
                });
                sel.disabled = false;

                if (available.length === 0) {
                    sel.innerHTML = '<option>All users are already members</option>';
                    sel.disabled = true;
                }
            }
        } catch (e) {
            console.error(e);
            sel.innerHTML = '<option>Error loading users</option>';
        }
    }

    async function addMember() {
        const userId = document.getElementById('new-member-select').value;
        if (!userId) return;

        try {
            const res = await fetch(`/api/projects/${PROJECT_ID}/members`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });

            if (res.ok) {
                showToast('Member added successfully', 'success');
                document.getElementById('add-member-modal').classList.add('hidden');
                loadProjectDetails(); // Reload to update list
            } else {
                const err = await res.json();
                alert(err.error || 'Failed to add member'); // Fallback to alert if showToast weird, but showToast should work
            }
        } catch (e) {
            console.error(e);
            alert('Network error');
        }
    }

    // --- NEW: Tabs, Comments & Attachments Logic ---

    function switchTab(tabName) {
        // 1. Hide all contents
        ['details', 'comments', 'attachments'].forEach(t => {
            document.getElementById(`tab-content-${t}`).classList.add('hidden');
            const btn = document.getElementById(`tab-btn-${t}`);
            btn.classList.remove('text-emerald-600', 'border-b-2', 'border-emerald-600');
            btn.classList.add('text-slate-500');
        });

        // 2. Show active
        document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        const activeBtn = document.getElementById(`tab-btn-${tabName}`);
        activeBtn.classList.remove('text-slate-500');
        activeBtn.classList.add('text-emerald-600', 'border-b-2', 'border-emerald-600');

        // Load data if needed
        if (tabName === 'comments') loadComments(currentPreviewTaskId);
        if (tabName === 'attachments') loadAttachments(currentPreviewTaskId);
    }

    // --- Open Preview Override ---
    function openTaskPreview(taskId) {
        currentPreviewTaskId = taskId;
        const t = currentProjectTasks.find(x => x.id === taskId);
        if (!t) return;

        // Reset Tab to Details
        switchTab('details');

        // Populate Basics
        document.getElementById('preview-title').innerText = t.title;
        document.getElementById('preview-desc').innerText = t.description || 'No description provided.';
        document.getElementById('preview-status').innerText = t.status;
        document.getElementById('preview-created').innerText = new Date(t.created_at).toLocaleDateString();

        const pEl = document.getElementById('preview-priority');
        pEl.innerText = t.priority;
        pEl.className = 'text-xs font-bold px-2 py-0.5 rounded uppercase tracking-wider ';
        if (t.priority === 'High') pEl.classList.add('bg-red-100', 'text-red-700');
        else if (t.priority === 'Medium') pEl.classList.add('bg-orange-100', 'text-orange-700');
        else pEl.classList.add('bg-green-100', 'text-green-700');

        const dEl = document.getElementById('preview-deadline');
        if (t.deadline) {
            dEl.innerText = new Date(t.deadline).toLocaleString(undefined, {
                year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        } else {
            dEl.innerText = 'No Deadline';
        }

        const aBox = document.getElementById('preview-assignee-box');
        if (t.assignee) {
            const avatar = t.assignee.avatar_url || ('https://ui-avatars.com/api/?name=' + t.assignee.full_name);
            aBox.innerHTML = `<img src="${avatar}" class="w-8 h-8 rounded-full border border-slate-200"><span class="text-sm font-semibold text-slate-700">${t.assignee.full_name}</span>`;
        } else {
            aBox.innerHTML = '<span class="text-sm text-slate-400 italic">Unassigned</span>';
        }

        document.getElementById('task-preview-modal').classList.remove('hidden');
    }


    // --- Comments System ---
    async function loadComments(taskId) {
        const list = document.getElementById('comments-list');
        list.innerHTML = '<div class="text-center text-slate-400 py-10">Loading...</div>';

        try {
            const res = await fetch(`/api/tasks/${taskId}/comments`);
            if (res.ok) {
                const comments = await res.json();
                renderComments(comments);
            } else {
                list.innerHTML = '<div class="text-center text-red-400 py-4">Failed to load comments</div>';
            }
        } catch (e) { console.error(e); }
    }

    function renderComments(comments) {
        const list = document.getElementById('comments-list');
        if (comments.length === 0) {
            list.innerHTML = '<div class="text-center text-slate-400 py-10">No comments yet. Start the discussion!</div>';
            return;
        }

        list.innerHTML = comments.map(c => {
            const user = c.user || { full_name: 'Unknown', avatar_url: null };
            const avatar = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}`;
            const date = new Date(c.created_at).toLocaleString();

            return `
                <div class="flex space-x-3 group">
                    <img src="${avatar}" class="w-8 h-8 rounded-full border border-white shadow-sm mt-1">
                    <div class="flex-1">
                         <div class="bg-slate-100/50 p-3 rounded-tr-xl rounded-br-xl rounded-bl-xl border border-slate-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-slate-700">${user.full_name}</span>
                                <span class="text-[10px] text-slate-400">${date}</span>
                            </div>
                            <p class="text-sm text-slate-700 whitespace-pre-wrap">${c.content}</p>
                         </div>
                    </div>
                </div>
            `;
        }).join('');

        // Scroll to bottom
        list.scrollTop = list.scrollHeight;
    }

    async function postComment() {
        if (!currentPreviewTaskId) return;
        const txt = document.getElementById('new-comment-text');
        const content = txt.value.trim();
        if (!content) return;

        // Optimistic UI could go here, but let's just wait
        try {
            const res = await fetch(`/api/tasks/${currentPreviewTaskId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            if (res.ok) {
                txt.value = '';
                loadComments(currentPreviewTaskId);
            } else {
                alert("Failed to post comment");
            }
        } catch (e) { console.error(e); }
    }


    // --- Attachments System ---
    async function loadAttachments(taskId) {
        const list = document.getElementById('attachments-list');
        list.innerHTML = '<div class="text-center text-slate-400 py-4">Loading...</div>';

        try {
            const res = await fetch(`/api/tasks/${taskId}/attachments`);
            if (res.ok) {
                const files = await res.json();
                if (files.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-400 py-4">No attachments yet.</div>';
                } else {
                    list.innerHTML = files.map(f => {
                        const isImg = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(f.file_type.toLowerCase());
                        const icon = isImg ?
                            `<svg class="w-8 h-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>` :
                            `<svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`;

                        return `
                            <div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl hover:shadow-sm transition group">
                                <div class="flex items-center space-x-3 overflow-hidden">
                                    <div class="flex-shrink-0 bg-slate-50 p-2 rounded-lg">${icon}</div>
                                    <div class="truncate">
                                        <p class="text-sm font-medium text-slate-700 truncate" title="${f.file_name}">${f.file_name}</p>
                                        <p class="text-xs text-slate-400">${new Date(f.created_at).toLocaleDateString()}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <a href="${f.file_url}" target="_blank" download class="text-slate-400 hover:text-emerald-600 p-2 rounded-full hover:bg-emerald-50 transition" title="Download">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    </a>
                                    <button onclick="deleteAttachment('${f.id}')" class="text-slate-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition" title="Delete">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862A2 2 0 016.862 21L6 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                         `;
                    }).join('');
                }
            } else {
                list.innerHTML = '<div class="text-center text-red-300 py-4">Failed (Table missing?)</div>';
            }
        } catch (e) { console.error(e); }
    }

    async function uploadAttachment(file) {
        if (!file || !currentPreviewTaskId) return;

        // Show progress (fake for now or use XHR)
        const bar = document.getElementById('upload-progress');
        bar.classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(`/api/tasks/${currentPreviewTaskId}/attachments`, {
                method: 'POST',
                body: formData
            });

            bar.classList.add('hidden');

            if (res.ok) {
                showToast("File uploaded!", "success");
                loadAttachments(currentPreviewTaskId);
            } else {
                const err = await res.json();
                alert("Upload failed: " + (err.error || 'Server error'));
            }
        } catch (e) {
            bar.classList.add('hidden');
            console.error(e);
            alert("Upload failed");
        }
    }

    function deleteAttachment(attachmentId) {
        document.getElementById('del-modal-title').innerText = 'Delete Attachment?';
        document.getElementById('del-modal-desc').innerText = 'Are you sure you want to delete this file? This cannot be undone.';

        const btn = document.getElementById('del-modal-btn');
        btn.onclick = () => confirmDeleteAttachment(attachmentId);

        document.getElementById('delete-confirm-modal').classList.remove('hidden');
    }

    async function confirmDeleteAttachment(attachmentId) {
        try {
            const btn = document.getElementById('del-modal-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Deleting...';
            btn.disabled = true;

            const res = await fetch(`/api/attachments/${attachmentId}`, { method: 'DELETE' });

            if (res.ok) {
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                showToast("Attachment deleted", "success");
                loadAttachments(currentPreviewTaskId);
            } else {
                const err = await res.json();
                alert("Failed to delete: " + (err.error || 'Unknown error'));
            }
            btn.innerText = originalText;
            btn.disabled = false;
        } catch (e) {
            console.error(e);
            alert("Network error");
            document.getElementById('del-modal-btn').innerText = 'Yes, Delete';
            document.getElementById('del-modal-btn').disabled = false;
        }
    }
</script>
{% endblock %}
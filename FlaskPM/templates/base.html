<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DigiAnchorz PM{% endblock %}</title>

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/jpg" href="{{ url_for('static', filename='images/company_icon.jpg') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/company_icon.jpg') }}">

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}")
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Fail', err));
            });
        }
    </script>

    <!-- Suppress Tailwind CDN Warning for Dev -->
    <script>
        const _origWarn = console.warn;
        console.warn = function (...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            _origWarn.apply(console, args);
        };
    </script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Flatpickr (Dark Theme) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Tailwind Configuration for Custom Colors/Fonts -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.7)',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% block head %}{% endblock %}
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #fffbeb 100%);
            /* Green-50 to Amber-50 */
            min-height: 100vh;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid rgba(255, 255, 255, 0.6);
        }

        .glass-static {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="text-slate-700 antialiased overflow-hidden selection:bg-emerald-100 selection:text-emerald-700">
    <!-- Supabase Setup -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "{{ config['SUPABASE_URL'] }}";
        const SUPABASE_KEY = "{{ config['SUPABASE_KEY'] }}";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>
    <!-- JS Inlined below for reliability -->

    <div class="flex h-screen w-full relative">

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" onclick="toggleSidebar()"
            class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden md:hidden transition-all duration-300 opacity-0"
            style="transition: opacity 0.3s ease-in-out;">
        </div>


        <!-- Sidebar -->
        <aside
            class="w-64 h-full glass-sidebar flex flex-col transition-all duration-300 z-50 fixed md:relative -translate-x-full md:translate-x-0"
            id="sidebar">
            <!-- Brand -->
            <div class="h-24 flex items-center px-6 border-b border-emerald-50">
                <a href="/" class="group flex items-center">
                    <img src="{{ url_for('static', filename='images/logo_final.jpg') }}" alt="DigiAnchorz"
                        class="h-16 w-auto object-contain transform group-hover:scale-105 transition duration-300">
                </a>
            </div>

            <!-- Nav -->
            <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1.5 scrollbar-hide">
                <a href="/"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path == '/' else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path == '/' else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                    Dashboard
                </a>

                <a href="/tasks"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/tasks') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/tasks') else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                        </path>
                    </svg>
                    Tasks
                </a>

                <a href="/projects"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/projects') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/projects') else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    Projects
                </a>

                <a href="/attendance"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/attendance') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/attendance') else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Attendance
                </a>

                <a href="/calendar"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/calendar') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/calendar') else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    Calendar
                </a>

                <a href="/reports"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/reports') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/reports') else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Reports
                </a>

                <a href="/team"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/team') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                    <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/team') else 'text-slate-400 group-hover:text-emerald-500' }}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    Team
                </a>

                <div class="pt-4 mt-4 border-t border-emerald-50">
                    <a href="/settings"
                        class="flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {{ 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-200/50' if request.path.startswith('/settings') else 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' }}">
                        <svg class="w-5 h-5 mr-3 {{ 'text-white' if request.path.startswith('/settings') else 'text-slate-400 group-hover:text-emerald-500' }}"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Settings
                    </a>
                </div>
            </nav>

            <div class="p-6">
                <!-- User Profile -->
                <!-- User Profile -->
                <div class="flex items-center space-x-3 mb-4">
                    <div
                        class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-amber-500 text-white flex items-center justify-center font-bold text-sm shadow-md">
                        {% if session.get('user') and session['user'].get('user_metadata') %}
                        {{ session['user']['user_metadata'].get('full_name', 'U')[0]|upper }}
                        {% else %}
                        U
                        {% endif %}
                    </div>
                    <div>
                        <p class="text-sm font-bold text-slate-800">
                            {% if session.get('user') and session['user'].get('user_metadata') %}
                            {{ session['user']['user_metadata'].get('full_name', 'User') }}
                            {% else %}
                            User
                            {% endif %}
                        </p>
                        <button onclick="handleSignOut()"
                            class="text-xs text-red-500 hover:text-red-700 font-medium">Sign Out</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col h-screen relative overflow-hidden">
            <!-- Header -->
            <header
                class="absolute top-0 w-full h-20 flex items-center justify-between px-8 z-40 bg-white/50 backdrop-blur-xl border-b border-white/50">
                <div class="flex items-center space-x-4">
                    <!-- Mobile Toggle -->
                    <button onclick="toggleSidebar()"
                        class="md:hidden p-2 text-slate-500 hover:text-emerald-600 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold text-slate-800">{% block header_title %}Dashboard{% endblock %}</h1>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Search -->
                    <div class="relative">
                        <button onclick="toggleSearch()"
                            class="p-2 rounded-full hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <div id="search-bar"
                            class="hidden absolute right-0 top-12 w-80 bg-white p-4 rounded-2xl shadow-xl border border-emerald-50 transform origin-top-right transition-all z-50">
                            <input type="text" id="global-search" placeholder="Search projects or tasks..."
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:bg-white transition"
                                onkeyup="handleGlobalSearch()">
                            <div id="search-results" class="mt-2 max-h-60 overflow-y-auto space-y-2"></div>
                        </div>
                    </div>

                    <!-- Notification Button -->
                    <button onclick="toggleNotifications()"
                        class="p-2 rounded-full glass-static hover:bg-white/80 transition text-slate-500 relative">
                        <span id="notif-badge"
                            class="hidden absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 rounded-full border-2 border-white shadow-md transform scale-100 transition-transform">0</span>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                            </path>
                        </svg>
                    </button>

                    <!-- Notification Dropdown -->
                    <div id="notif-dropdown"
                        class="hidden absolute top-14 right-6 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 ring-1 ring-black/5 z-50 overflow-hidden transform transition-all duration-200 origin-top-right">
                        <div
                            class="px-5 py-3 border-b border-emerald-50 bg-emerald-50/50 flex justify-between items-center">
                            <h3 class="font-bold text-emerald-900 text-xs uppercase tracking-wider">Notifications</h3>
                            <button onclick="clearAllNotifications()"
                                class="text-[10px] font-semibold text-emerald-600 hover:text-emerald-800 bg-white px-2 py-1 rounded-md shadow-sm border border-emerald-100 transition">Mark
                                all read</button>
                        </div>
                        <div id="notif-list" class="max-h-80 overflow-y-auto">
                            <div class="py-8 text-center text-xs text-slate-400">Loading...</div>
                        </div>
                    </div>
                </div>

            </header>

            <main class="flex-1 overflow-y-auto pt-24 px-6 pb-6 no-scrollbar">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    <!-- AI Chat Widget -->
    <div id="ai-chat-widget" class="fixed bottom-6 right-6 z-50 font-sans">
        <!-- Chat Window -->
        <div id="chat-window"
            class="hidden glass-panel w-80 md:w-96 rounded-2xl shadow-2xl flex flex-col mb-4 overflow-hidden transition-all duration-200 transform origin-bottom-right scale-95 opacity-0">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-800 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                        </path>
                    </svg>
                    AI Assistant
                </h3>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><svg class="w-5 h-5" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>
            <div id="chat-messages"
                class="h-80 overflow-y-auto p-4 space-y-3 bg-white/50 scrollbar-thin scrollbar-thumb-emerald-200">
                <!-- Messages -->
                <div class="flex justify-start">
                    <div
                        class="bg-white text-slate-700 border border-slate-100 shadow-sm rounded-2xl rounded-tl-none px-4 py-2 text-sm max-w-[80%]">
                        Hello! I'm your AI assistant. Ask me anything about your projects or tasks.
                    </div>
                </div>
            </div>
            <div class="p-3 bg-white/80 border-t border-emerald-100 flex items-center">
                <input type="text" id="chat-input"
                    class="flex-1 bg-transparent border-0 focus:ring-0 text-sm placeholder-slate-400 focus:outline-none px-2"
                    placeholder="Type a message...">
                <button onclick="sendChatMessage()"
                    class="ml-2 p-2 bg-emerald-600 text-white rounded-full hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/30">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9-2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleChat()"
            class="bg-gradient-to-r from-emerald-600 to-amber-500 text-white p-4 rounded-full shadow-lg shadow-emerald-500/40 hover:scale-110 transition-transform float-right group relative">
            <span class="absolute -top-1 -right-1 flex h-3 w-3">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span>
            </span>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                </path>
            </svg>
        </button>
    </div>

    <script>
        function toggleChat() {
            const win = document.getElementById('chat-window');
            if (win.classList.contains('hidden')) {
                win.classList.remove('hidden');
                setTimeout(() => {
                    win.classList.remove('opacity-0', 'scale-95');
                    document.getElementById('chat-input').focus();
                }, 10);
            } else {
                win.classList.add('opacity-0', 'scale-95');
                setTimeout(() => win.classList.add('hidden'), 200);
            }
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // User Message
            appendMessage(msg, 'user');
            input.value = '';

            // Simulate thinking UI
            const chats = document.getElementById('chat-messages');
            const loadingId = 'loading-' + Date.now();
            chats.innerHTML += `<div id="${loadingId}" class="flex justify-start"><div class="bg-indigo-50 text-indigo-400 rounded-2xl rounded-tl-none px-4 py-2 text-sm italic">Typing...</div></div>`;
            chats.scrollTop = chats.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();

                const lEl = document.getElementById(loadingId);
                if (lEl) lEl.remove();

                appendMessage(data.response || "I didn't quite get that.", 'ai');

            } catch (e) {
                const lEl = document.getElementById(loadingId);
                if (lEl) lEl.remove();
                appendMessage("I'm having trouble retrieving information right now.", 'ai');
            }
        }

        // --- GLOBAL SEARCH & NOTIFICATIONS ---

        function toggleSearch() {
            const bar = document.getElementById('search-bar');
            const input = document.getElementById('global-search');
            bar.classList.toggle('hidden');
            if (!bar.classList.contains('hidden')) {
                input.focus();
            }
        }

        let searchDebounce;
        async function handleGlobalSearch() {
            const query = document.getElementById('global-search').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');

            clearTimeout(searchDebounce);

            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.add('hidden');
                return;
            }

            searchDebounce = setTimeout(async () => {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = '<div class="text-slate-400 text-sm p-4 text-center">Searching...</div>';

                // Fetch simple results from tasks API (client-side filtering for simplicity if small data, or assume API support)
                // For now, let's fetch ALL tasks (limit 50) and filter clientside as a demo
                try {
                    const res = await fetch('/api/tasks');
                    const tasks = await res.json();

                    const filtered = tasks.filter(t => t.title.toLowerCase().includes(query) || (t.project && t.project.title.toLowerCase().includes(query)));

                    if (filtered.length === 0) {
                        resultsDiv.innerHTML = '<div class="text-slate-400 text-sm p-4 text-center">No results found</div>';
                        return;
                    }

                    resultsDiv.innerHTML = filtered.map(t => `
                        <a href="/projects/${t.project_id}" class="block p-3 hover:bg-slate-50 rounded-xl transition flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-slate-700 text-sm">${t.title}</h4>
                                <p class="text-xs text-slate-500">${t.project ? t.project.title : 'No Project'}</p>
                            </div>
                            <span class="text-xs font-mono bg-slate-100 text-slate-600 px-2 py-1 rounded">${t.status}</span>
                        </a>
                    `).join('');

                } catch (e) {
                    console.error(e);
                    resultsDiv.innerHTML = '<div class="text-red-400 text-sm p-4 text-center">Error searching</div>';
                }
            }, 300);
        }



        function appendMessage(text, sender) {
            const chats = document.getElementById('chat-messages');
            const align = sender === 'user' ? 'justify-end' : 'justify-start';
            const style = sender === 'user'
                ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-tr-none shadow-md'
                : 'bg-white text-slate-700 rounded-tl-none border border-slate-100 shadow-sm';

            const div = document.createElement('div');
            div.className = `flex ${align} `;
            div.innerHTML = `<div class="${style} rounded-2xl px-4 py-2 text-sm max-w-[80%]">${text}</div>`;
            chats.appendChild(div);
            chats.scrollTop = chats.scrollHeight;
        }
    </script>
    <!-- Core Application Logic (Inlined) -->
    <script>
        console.log("Antigravity PM: Inline Logic Loaded");

        // --- Helpers ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            // Current state check
            const isClosed = sidebar.classList.contains('-translate-x-full');

            if (isClosed) {
                // Open Sidebar
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                // Small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                }, 10);
            } else {
                // Close Sidebar
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return "Just now";
        }

        // --- Toasts ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-2xl shadow-2xl text-white transform transition-all duration-300 translate-y-10 opacity-0 z-[2000] flex items-center space-x-3 backdrop-blur-md border border-white/20 font-medium ${type === 'success' ? 'bg-slate-900/90' : 'bg-red-600/90'}`;
            if (type === 'success') {
                toast.innerHTML = `<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>${message}</span>`;
            } else if (type === 'error') {
                toast.innerHTML = `<svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>${message}</span>`;
            } else {
                toast.innerHTML = `<span>${message}</span>`;
            }
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-y-10', 'opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Auth ---
        async function handleSignOut() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                window.location.href = "/auth/logout";
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out. Force clearing session...', 'error');
                setTimeout(() => { window.location.href = "/auth/logout"; }, 1500);
            }
        }

        // --- Notifications ---
        function toggleNotifications() {
            const dropdown = document.getElementById('notif-dropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        }

        async function checkNotifications() {
            try {
                const res = await fetch('/api/notifications');
                if (!res.ok) {
                    // Fail silently to avoid console noise if 404/500
                    return;
                }
                const data = await res.json();

                let notifs = [];
                let unreadCount = 0;

                if (Array.isArray(data)) {
                    notifs = data;
                    unreadCount = data.filter(n => !n.is_read).length;
                } else {
                    notifs = data.notifications || [];
                    unreadCount = data.unread_count || 0;
                }

                updateNotificationUI(notifs, unreadCount);

                // Toast logic
                if (notifs.length > 0) {
                    const latest = notifs[0];
                    const lastSeenId = localStorage.getItem('last_notif_id');
                    if (latest.id !== lastSeenId) {
                        const created = new Date(latest.created_at);
                        const diffMins = (new Date() - created) / 1000 / 60;
                        if (diffMins < 60 && !latest.is_read) {
                            showToast(latest.message || "New Notification", 'info');
                        }
                        localStorage.setItem('last_notif_id', latest.id);
                    }
                }
            } catch (e) {
                console.warn("Notification sync failed", e);
                // Don't show error in UI unless user opens dropdown, handled by initial UI state
            }
        }

        function updateNotificationUI(notifs, unreadCount) {
            // Badge
            const badge = document.getElementById('notif-badge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            // List
            const list = document.getElementById('notif-list');
            if (!list) return;

            if (notifs.length === 0) {
                list.innerHTML = `
                    <div class="py-8 text-center flex flex-col items-center justify-center text-slate-400">
                        <svg class="w-8 h-8 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        <span class="text-xs">All caught up!</span>
                    </div>`;
                return;
            }

            // Rebuild List
            list.innerHTML = '';
            notifs.forEach(n => {
                const isRead = n.is_read;
                const timeAgo = getTimeAgo(n.created_at);
                const bgClass = isRead ? 'bg-white hover:bg-slate-50' : 'bg-indigo-50/30 hover:bg-indigo-50/60';
                const opacity = isRead ? 'opacity-75' : 'opacity-100';

                // Icon Logic
                let iconPath = "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9";
                if ((n.title || '').includes('Task')) iconPath = "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2";

                const item = document.createElement('div');
                item.className = `p-4 border-b border-slate-50 last:border-0 transition-colors cursor-pointer group ${bgClass}`;
                item.onclick = () => markRead(n.id, n.link);
                item.innerHTML = `
                    <div class="flex items-start space-x-3 ${opacity}">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isRead ? 'text-slate-400 bg-slate-100' : 'text-indigo-600 bg-indigo-100'}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs ${isRead ? 'text-slate-600 font-medium' : 'text-slate-800 font-bold'}">${escapeHtml(n.title)}</p>
                            <p class="text-[11px] text-slate-500 mt-0.5 line-clamp-2 leading-relaxed">${escapeHtml(n.message)}</p>
                            <p class="text-[10px] text-slate-400 mt-1">${timeAgo}</p>
                        </div>
                       ${!isRead ? '<div class="w-2 h-2 bg-indigo-500 rounded-full mt-1"></div>' : ''}
                    </div>`;
                list.appendChild(item);
            });
        }

        async function markRead(id, link) {
            try {
                await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
                checkNotifications();
                if (link && link !== 'null' && link !== 'undefined') window.location.href = link;
            } catch (e) { console.error(e); }
        }

        async function clearAllNotifications() {
            try {
                await fetch('/api/notifications/read-all', { method: 'POST' });
                checkNotifications();
            } catch (e) { console.error(e); }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            checkNotifications();
            setInterval(checkNotifications, 15000);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('notif-dropdown');
                const btn = document.querySelector('button[onclick="toggleNotifications()"]');
                if (!dropdown || dropdown.classList.contains('hidden')) return;
                if (btn && btn.contains(e.target)) return;
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Mobile Sidebar: Close when clicking a menu link
            const sidebarLinks = document.querySelectorAll('#sidebar nav a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    // Check if on mobile
                    if (window.innerWidth < 768) {
                        const sidebar = document.getElementById('sidebar');
                        if (!sidebar.classList.contains('-translate-x-full')) {
                            toggleSidebar();
                        }
                    }
                });
            });

            // Handle Resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    const overlay = document.getElementById('mobile-overlay');
                    if (overlay && !overlay.classList.contains('hidden')) {
                        overlay.classList.add('hidden', 'opacity-0');
                    }
                }
            });
        });
    </script>
</body>

</html>
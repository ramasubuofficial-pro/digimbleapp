{% extends "base.html" %}

{% block header_title %}Team Members{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Actions -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-xl font-bold text-slate-800">Team Directory</h2>
            <p class="text-slate-500 text-sm">Manage your team members and their roles.</p>
        </div>

        <!-- Only Admin can invite -->
        {% if user.role == 'Admin' %}
        <button onclick="openInviteModal()"
            class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Invite Member
        </button>
        {% endif %}
    </div>

    <!-- Team Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="team-grid">
        <!-- Loading State -->
        <div class="col-span-full text-center py-12 text-slate-400">
            Loading team members...
        </div>
    </div>
</div>

<!-- Invite Modal (Only useful if Admin) -->
<div id="invite-modal"
    class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden transform transition-all scale-100">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <h3 class="text-lg font-bold text-slate-800">Invite New Member</h3>
            <button onclick="closeInviteModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                <input type="email" id="invite-email" placeholder="colleague@example.com"
                    class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Role</label>
                <select id="invite-role"
                    class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none bg-white">
                    <option value="Member">Team Member</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
        </div>
        <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end space-x-3">
            <button onclick="closeInviteModal()"
                class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg font-medium transition">Cancel</button>
            <button onclick="sendInvite()"
                class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium shadow-lg shadow-emerald-500/30 transition">Send
                Invitation</button>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal (Standardized UI) -->
<div id="delete-confirm-modal"
    class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
        <div class="p-6">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mx-auto mb-4">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-center text-slate-800 mb-2">Remove Member?</h3>
            <p class="text-center text-slate-600">Are you sure you want to remove this member? This action cannot be
                undone.</p>
        </div>
        <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-center space-x-3">
            <button onclick="closeDeleteModal()"
                class="px-5 py-2.5 bg-white text-slate-700 hover:bg-slate-100 border border-slate-200 rounded-xl font-medium transition shadow-sm">Cancel</button>
            <button onclick="performDelete()"
                class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium shadow-lg shadow-red-500/30 transition">Remove</button>
        </div>
    </div>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadTeam);
    const CURRENT_USER_ROLE = "{{ user.role }}"; // 'Member', 'Admin' etc.

    function openInviteModal() {
        document.getElementById('invite-email').value = '';
        document.getElementById('invite-role').value = 'Member';
        document.getElementById('invite-modal').classList.remove('hidden');
    }

    function closeInviteModal() {
        document.getElementById('invite-modal').classList.add('hidden');
    }

    async function sendInvite() {
        const email = document.getElementById('invite-email').value;
        const role = document.getElementById('invite-role').value;

        if (!email) {
            showToast('Please enter an email address', 'error');
            return;
        }

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = 'Sending...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/invite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, role })
            });

            const data = await res.json();

            if (res.ok) {
                showToast(data.message); // Custom Toast
                document.getElementById('invite-email').value = '';
                closeInviteModal();
            } else {
                showToast(data.error || 'Failed to send invitation', 'error');
            }
        } catch (e) {
            showToast('Request failed: ' + e.message, 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    const CURRENT_USER_ID = "{{ user.id }}";

    let memberIdToDelete = null;

    function deleteMember(userId) {
        memberIdToDelete = userId;
        document.getElementById('delete-confirm-modal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        document.getElementById('delete-confirm-modal').classList.add('hidden');
        memberIdToDelete = null;
    }

    async function performDelete() {
        if (!memberIdToDelete) return;

        // Optimistic UI update or loading state could go here but modal is quick
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "Removing...";
        btn.disabled = true;

        try {
            const res = await fetch(`/api/team/${memberIdToDelete}`, { method: 'DELETE' });
            const data = await res.json();

            if (res.ok) {
                showToast(data.message || 'Member removed successfully');
                loadTeam(); // Reload content
            } else {
                showToast('Error removing member: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (e) {
            showToast('Request failed: ' + e.message, 'error');
        } finally {
            closeDeleteModal();
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function loadTeam() {
        try {
            const res = await fetch('/api/team'); // We need to create this endpoint
            const team = await res.json();
            const grid = document.getElementById('team-grid');
            grid.innerHTML = '';

            if (team.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-slate-500">No members found.</div>';
                return;
            }

            team.forEach(member => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition flex items-center space-x-4 relative';

                const initials = member.full_name ? member.full_name[0].toUpperCase() : (member.email[0].toUpperCase());

                // Condition to checking if this member is me
                const isMe = member.id === CURRENT_USER_ID;
                const isAdmin = CURRENT_USER_ROLE === 'Admin';

                // ONLY Admins can delete others. 
                // Perhaps protect removing self? Usually yes.
                const canDelete = isAdmin && !isMe;

                const deleteBtn = canDelete ? `
                    <button onclick="deleteMember('${member.id}')" class="text-slate-300 hover:text-red-500 transition p-1" title="Remove Member">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                ` : '';

                card.innerHTML = `
                    <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-xl font-bold text-slate-600">
                        ${member.avatar_url ? `<img src="${member.avatar_url}" class="w-full h-full rounded-full object-cover">` : initials}
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-slate-800">${member.full_name || 'Unknown User'} ${isMe ? '(You)' : ''}</h3>
                        <p class="text-xs text-slate-500">${member.email}</p>
                        <span class="inline-block mt-2 px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 text-xs font-semibold">
                            ${member.role || 'Member'}
                        </span>
                    </div>
                    <div class="flex flex-col space-y-2">
                        ${deleteBtn}
                    </div>
                `;
                grid.appendChild(card);
            });

        } catch (e) {
            console.error(e);
            document.getElementById('team-grid').innerHTML = '<div class="col-span-full text-center text-red-400">Failed to load team.</div>';
        }
    }
</script>
{% endblock %}
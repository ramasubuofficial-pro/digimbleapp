{% extends "base.html" %}

{% block title %}DIGIANCHORZ - Attendance{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div
        class="flex justify-between items-center bg-white/40 p-6 rounded-3xl border border-white/50 shadow-sm backdrop-blur-md">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-800">Attendance</h1>
            <p class="text-slate-500 mt-1">Track your daily work hours.</p>
        </div>
        <div class="text-right">
            <div class="text-2xl font-bold text-emerald-600" id="live-time">--:--:--</div>
            <div class="text-sm text-slate-500" id="live-date">-- -- ----</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- PUNCH CARD -->
        <div
            class="bg-white/60 p-8 rounded-3xl border border-white/50 shadow-sm backdrop-blur-md flex flex-col items-center justify-center space-y-6">
            <div id="status-badge" class="px-4 py-1 rounded-full text-sm font-semibold bg-slate-100 text-slate-500">
                Loading...
            </div>

            <div class="relative group cursor-pointer" onclick="handlePunch()">
                <div
                    class="absolute -inset-1 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200">
                </div>
                <button id="punch-btn"
                    class="relative w-48 h-48 rounded-full bg-white flex flex-col items-center justify-center border-4 border-emerald-50 shadow-xl transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-12 h-12 text-emerald-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        id="punch-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xl font-bold text-slate-700" id="punch-text">Punch In</span>
                </button>
            </div>

            <p class="text-sm text-center text-slate-500 max-w-xs" id="punch-info">
                Click to mark your attendance for today.
            </p>
        </div>

        <!-- HISTORY -->
        <div class="lg:col-span-2 bg-white/60 p-8 rounded-3xl border border-white/50 shadow-sm backdrop-blur-md">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-700">Attendance History</h3>
                <div class="flex space-x-2">
                    <select id="hist-month" onchange="loadHistory()"
                        class="px-3 py-2 rounded-xl border border-slate-200 bg-white/50 text-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <select id="hist-year" onchange="loadHistory()"
                        class="px-3 py-2 rounded-xl border border-slate-200 bg-white/50 text-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="p-3 text-sm font-semibold text-slate-500 border-b border-slate-200">Date</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 border-b border-slate-200">Punch In</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 border-b border-slate-200">In Location
                            </th>
                            <th class="p-3 text-sm font-semibold text-slate-500 border-b border-slate-200">Punch Out
                            </th>
                            <th class="p-3 text-sm font-semibold text-slate-500 border-b border-slate-200">Out Location
                            </th>
                            <th class="p-3 text-sm font-semibold text-slate-500 border-b border-slate-200">Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="text-slate-700 text-sm">
                        <!-- JS will populate -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    <!-- LOCATION CONFIRM MODAL -->
    <div id="loc-modal"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-96 max-w-full m-4">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Confirm Location</h3>
            <p class="text-sm text-slate-500 mb-4">
                We detected the following location. If it's incorrect (e.g. wrong city due to Wi-Fi), please edit it
                below.
            </p>

            <textarea id="loc-input" rows="3"
                class="w-full text-sm p-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 mb-4 bg-slate-50 text-slate-700"></textarea>

            <div class="flex space-x-3">
                <button onclick="closeLocModal()"
                    class="flex-1 py-2 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition">
                    Cancel
                </button>
                <button onclick="confirmPunch()"
                    class="flex-1 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">
                    Confirm & Punch
                </button>
            </div>
            <div id="loc-debug" class="mt-2 text-xs text-slate-400 text-center"></div>
        </div>
    </div>

</div>

<script>
    // Live Clock
    function updateClock() {
        const now = new Date();
        document.getElementById('live-time').innerText = now.toLocaleTimeString();
        document.getElementById('live-date').innerText = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Populate Year Dropdown & Set Defaults
    (function initFilters() {
        const today = new Date();
        const yearSel = document.getElementById('hist-year');
        const monthSel = document.getElementById('hist-month');

        const currentYear = today.getFullYear();
        for (let y = currentYear; y >= currentYear - 2; y--) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            yearSel.appendChild(opt);
        }

        // Set current month/year
        monthSel.value = today.getMonth() + 1; // 0-indexed
        yearSel.value = currentYear;
    })();

    let currentStatus = 'none'; // none, punched_in, completed
    let pendingLocation = ''; // Store detected location

    function safeParseTime(isoStr) {
        if (!isoStr) return '-';
        let cleanStr = isoStr;

        // Only append Z if it looks naive (no Z, no +offset, no -offset at end)
        // Check if it ends in Z
        const endsInZ = cleanStr.toUpperCase().endsWith('Z');
        // Check for timezone offset pattern at the end like +05:30 or -0400
        const hasOffset = /[+-]\d{2}:?\d{2}$/.test(cleanStr);

        if (!endsInZ && !hasOffset) {
            cleanStr += 'Z';
        }

        const d = new Date(cleanStr);
        if (isNaN(d.getTime())) return 'Invalid Date';
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    async function loadToday() {
        const btn = document.getElementById('punch-btn');
        const txt = document.getElementById('punch-text');
        const badge = document.getElementById('status-badge');
        const info = document.getElementById('punch-info');

        try {
            const res = await fetch('/api/attendance/today');
            if (res.status === 401) window.location.href = '/login';

            const data = await res.json(); // returns null if no record, or object

            if (!data) {
                // Not punched in yet
                currentStatus = 'none';
                txt.innerText = "Punch In";
                badge.innerText = "Not Checked In";
                badge.className = "px-4 py-1 rounded-full text-sm font-semibold bg-slate-200 text-slate-600";
                btn.disabled = false;
            } else if (data.punch_out) {
                // Completed
                currentStatus = 'completed';
                txt.innerText = "Completed";
                badge.innerText = "Day Completed";
                badge.className = "px-4 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-600";
                info.innerText = `You worked today. Great job!`;
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                // Punched In
                currentStatus = 'punched_in';
                txt.innerText = "Punch Out";
                badge.innerText = "Checked In";
                badge.className = "px-4 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-600";

                const inTime = safeParseTime(data.punch_in);
                info.innerText = `You punched in at ${inTime}. Click to punch out.`;
                btn.disabled = false;
            }

        } catch (e) {
            console.error(e);
        }
    }

    // Helper: Promisified Geolocation with Fallback
    function getPositionSafe() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error("Geolocation not supported"));
                return;
            }

            // 1. Try High Accuracy (GPS) - Timeout 20s
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve(pos),
                (err) => {
                    console.warn("High Accuracy Geo failed. Retrying Low Accuracy...", err);
                    // 2. Fallback: Low Accuracy (WiFi/IP) - Timeout 20s
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve(pos),
                        (errFinal) => reject(errFinal),
                        { enableHighAccuracy: false, timeout: 20000, maximumAge: 0 }
                    );
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );
        });
    }

    // CONFIGURATION: Enter your Google Maps API Key here for better accuracy
    // If empty, it falls back to free OpenStreetMap (less accurate for Indian villages)
    const GOOGLE_API_KEY = '';

    // Step 1: Detect Location & Open Modal
    async function handlePunch() {
        const btn = document.getElementById('punch-btn');
        const txt = document.getElementById('punch-text');

        if (btn.disabled) return;
        btn.disabled = true;
        const originalText = txt.innerText;
        txt.innerText = "Locating...";

        let finalLat, finalLong, finalSource = 'GPS';

        try {
            // Get Coords
            const pos = await getPositionSafe();
            finalLat = pos.coords.latitude;
            finalLong = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            if (acc > 5000) showToast(`Low Accuracy (${Math.round(acc)}m). Use Wi-Fi/GPS.`, "warning");
            finalSource = `Acc: ${Math.round(acc)}m`;

            let locationStr = `${finalLat.toFixed(5)}, ${finalLong.toFixed(5)}`;

            // Reverse Geocode
            try {
                if (GOOGLE_API_KEY) {
                    const gRes = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${finalLat},${finalLong}&key=${GOOGLE_API_KEY}`);
                    const gData = await gRes.json();
                    if (gData.status === 'OK' && gData.results && gData.results.length > 0) {
                        locationStr = gData.results[0].formatted_address;
                    }
                } else {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${finalLat}&lon=${finalLong}&zoom=18&addressdetails=1`, {
                        headers: { 'Accept-Language': 'en-IN,en-GB,en-US;q=0.9,en;q=0.8' },
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (geoRes.ok) {
                        const geoData = await geoRes.json();
                        if (geoData.address) {
                            const addr = geoData.address;
                            const locality = addr.suburb || addr.neighbourhood || addr.village || addr.quarter || addr.residential || addr.road || '';
                            let city = addr.city || addr.town || addr.municipality || '';
                            let district = addr.state_district || addr.county || addr.district || '';
                            const state = addr.state || '';

                            district = district.replace(/ District$/i, '').trim();
                            city = city.replace(/ District$/i, '').trim();
                            if (locality.toLowerCase() === city.toLowerCase()) city = '';
                            if (city.toLowerCase() === district.toLowerCase()) district = '';
                            if (locality.toLowerCase() === district.toLowerCase()) district = '';

                            let parts = [locality, city, district, state].filter(p => p && p.trim().length > 0);
                            locationStr = parts.join(', ');
                            if (locationStr.length < 3 && geoData.display_name) locationStr = geoData.display_name.split(',').slice(0, 3).join(',');
                        }
                    }
                }
            } catch (err) { console.warn("Reverse geo error", err); }

            // DEBUG INFO for user
            document.getElementById('loc-debug').innerText = `Source: ${finalSource} | ${finalLat.toFixed(4)}, ${finalLong.toFixed(4)}`;

            // OPEN MODAL
            document.getElementById('loc-input').value = locationStr;
            document.getElementById('loc-modal').classList.remove('hidden');

            // Re-enable button underneath (in case they cancel)
            btn.disabled = false;
            txt.innerText = originalText;

        } catch (error) {
            console.error(error);
            let msg = "Unable to retrieve location.";
            if (error.message && error.message.includes("Geolocation not supported")) msg = "Geolocation not supported.";
            else if (error.code === 1) msg = "Locating Denied: Please allow access.";
            else if (error.code === 2) msg = "Position Unavailable (Enable GPS/WiFi).";
            else if (error.code === 3 || (error.message && error.message.includes("timeout"))) msg = "Location Timeout. Retry.";
            showToast(msg, "error");
            btn.disabled = false;
            txt.innerText = originalText;
        }
    }

    function closeLocModal() {
        document.getElementById('loc-modal').classList.add('hidden');
    }

    // Step 2: Confirm & Send to Server
    async function confirmPunch() {
        const finalLoc = document.getElementById('loc-input').value;
        if (!finalLoc || finalLoc.trim().length < 3) {
            showToast("Please enter a valid location.", "warning");
            return;
        }

        closeLocModal();

        const btn = document.getElementById('punch-btn');
        const txt = document.getElementById('punch-text');

        btn.disabled = true;
        const originalText = txt.innerText; // "Punch In" or "Punch Out"
        txt.innerText = "Punching...";

        try {
            const res = await fetch('/api/attendance/punch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location: finalLoc })
            });
            const result = await res.json();

            if (result.warning === "missing_col") showToast("Punch successful, but Location column missing in DB.", "warning");

            if (res.ok) {
                loadToday();
                loadHistory();
            } else {
                showToast(result.error || "Error punching.", "error");
                btn.disabled = false;
                txt.innerText = originalText;
            }
        } catch (e) {
            console.error(e);
            showToast("Network Error during punch.", "error");
            btn.disabled = false;
            txt.innerText = originalText;
        }
    }

    async function loadHistory() {
        const tbody = document.getElementById('history-body');
        const month = document.getElementById('hist-month').value;
        const year = document.getElementById('hist-year').value;

        tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">Loading records...</td></tr>';

        try {
            const params = new URLSearchParams({ month, year });
            const res = await fetch(`/api/attendance/history?${params}`);
            const data = await res.json();

            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">No records found.</td></tr>';
                return;
            }

            data.forEach(row => {
                const date = new Date(row.date).toLocaleDateString();
                const inTime = safeParseTime(row.punch_in);
                const outTime = safeParseTime(row.punch_out);

                let statusColor = 'text-slate-600';
                if (row.status === 'Present') statusColor = 'text-emerald-600 font-semibold';

                const tr = `
                 <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                     <td class="p-3 text-slate-600 align-top">${date}</td>
                     <td class="p-3 font-mono text-slate-600 align-top">${inTime}</td>
                     <td class="p-3 text-xs text-slate-500 max-w-[150px] align-top truncate" title="${row.location || ''}">${row.location || '-'}</td>
                     <td class="p-3 font-mono text-slate-600 align-top">${outTime}</td>
                     <td class="p-3 text-xs text-slate-500 max-w-[150px] align-top truncate" title="${row.punch_out_location || ''}">${row.punch_out_location || '-'}</td>
                     <td class="p-3 ${statusColor} align-top">${row.status || '-'}</td>
                 </tr>
               `;
                tbody.insertAdjacentHTML('beforeend', tr);
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-400">Error loading history</td></tr>';
        }
    }

    // Init
    loadToday();
    loadHistory();

</script>
{% endblock %}